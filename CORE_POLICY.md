# CORE_POLICY — 設計原理憲章

> **このドキュメントは本プロジェクトにおける全ての意思決定の最上位基準である。**
> 仕様の詳細、技術選定、UIデザイン、どのような判断であっても
> ここに記された定義と原理に矛盾する選択を行ってはならない。

---

## §0: プロダクト定義 — 何を作るか

### 本質

**宇部工業高等専門学校キャンパスの空間情報デジタルツイン基盤。**

物理世界のキャンパス空間（建物・部屋・廊下・階段・渡り廊下・屋外通路）を、
**数理モデルとして抽象化**し、グラフ構造で再現するシステムである。

単なる「地図アプリ」ではない。
渡り廊下で繋がる複数の建物、複雑な階層構造、日々の業務・天候による物理的制約を
計算に組み込める**実務レベルの空間情報基盤**を構築する。

### 2つの顔

| 層 | 対象 | 目的 |
|---|---|---|
| **トレースエディター** | 管理者・データ構築者 | 平面図から空間をグラフとしてトレース・編集 |
| **キャンパスビューアー** | 教職員・学生 | 条件付きルート検索・施設情報の閲覧 |

### 技術的制約（不変）

| 制約 | 理由 |
|---|---|
| **描画: React DOM** | すべての空間要素はDOMノードとして描画する。Canvas/WebGLは使用しない |
| **データ: JSON** | すべてのキャンパスデータはJSON形式で管理する |
| **配布形態: Reactコンポーネント** | マップは描画要素と操作関数を持つReactコンポーネントとして提供する |
| **空間の表現: 数理モデル** | すべての空間要素は座標・ベクトル・グラフ等の数理モデルとして抽象化する |

---

## §1: 原理の適用方法

判断に迷ったとき、以下の手順で思考せよ。

1. **§0（プロダクト定義）に立ち返る** — 作ろうとしているものは定義に合致するか？
2. **該当する原理を特定する** — 今の判断はどの原理に関わるか？
3. **原理の優先度を確認する** — 複数の原理が競合する場合、番号が小さい原理が優先する。
4. **違反チェックを行う** — 選択肢が原理に違反していないか検証する。
5. **判断を記録する** — なぜその選択をしたか、どの原理に基づくかを明記する。

---

## P-1: Topology First — 接続性の絶対視

> **空間は「絵」ではなく「グラフ」である。**

### 宣言

形状（Geometry）は接続性（Topology）に従属する。
すべての空間要素（部屋・廊下・階段・渡り廊下）は、
移動可能なノードとエッジからなるグラフ構造として数学的に定義されなければならない。

### 判断基準

| 問い | 正しい答え |
|---|---|
| 「見た目は綺麗だがグラフとして不整合」と「見た目は粗いがグラフとして正しい」のどちらを優先するか？ | **グラフの正しさ** |
| ポリゴンの形状編集をユーザーに許可するか？ | 許可するが、**エッジの接続性が壊れる操作は拒否する** |
| 新しいノード種別を追加してよいか？ | グラフ構造に組み込めるなら許可。孤立ノードになる設計は不可 |

### この原理から導かれる制約

- すべての空間はノードIDを持ち、隣接する空間とエッジで結合される
- 「孤立ノード（どこにも繋がらない部屋）」はバリデーションエラーとする
- データ保存時にグラフの連結性チェックを必ず実行する
- ビジュアル（描画座標）とトポロジー（グラフ構造）は別レイヤーで管理する

---

## P-2: Constraint-Driven Editing — 制約駆動の編集

> **人間は必ずミスをする。システムが正しさを保証せよ。**

### 宣言

自由描画を許容するのではなく、システムが強力な制約（スナップ・整合性チェック・
自動補完）を課すことで、入力データの品質と一貫性を編集時点で担保する。

### 判断基準

| 問い | 正しい答え |
|---|---|
| ユーザーが物理的にありえない操作（壁を貫通するドアなど）を要求した場合は？ | **操作を拒否し、理由を表示する** |
| スナップ機能は任意に無効化できるべきか？ | **基本スナップは常時有効。精密モードで閾値調整は可** |
| バリデーションエラーがある状態で保存を許すか？ | **警告付きで保存は許可するが、エラーを明示し続ける** |

### この原理から導かれる制約

- 頂点スナップ（壁の端点・交点）はデフォルトで有効
- ドアの配置は壁のセグメント上にのみ許可
- 階段のノードは上下階の対応ノードが存在しなければ警告
- すべての制約違反は即座にUI上で可視化（赤いハイライト等）

---

## P-3: Context-Aware Dynamics — 文脈認識型の動的計算

> **「最短距離」は正解ではない。「最も適切な経路」を導け。**

### 宣言

距離だけでなく、運搬物の物理的制約、天候、時間帯、混雑度などの
現実世界の文脈をエッジのコスト（重み）としてグラフ探索アルゴリズムに組み込み、
状況に応じた最適経路を動的に計算する。

### 判断基準

| 問い | 正しい答え |
|---|---|
| エッジの「コスト」は距離だけで十分か？ | **不十分。段差・屋内外・道幅・混雑度を含む多次元コストとする** |
| 新しいコスト要素を追加するのは容易であるべきか？ | **はい。コスト関数はプラガブルに拡張可能な設計にする** |
| ルーティングプロファイル（台車モード等）は事前定義のみか？ | **定義済みプロファイル＋カスタムプロファイル作成の両方を想定する** |

### この原理から導かれる制約

- エッジの属性として `段差`, `屋外フラグ`, `道幅`, `混雑度` 等を持てる（自動補完で初期値設定）
- コスト計算は `CostFunction(edge, profile, context) → number` のインターフェースで統一
- ルーティングプロファイルは JSON で宣言的に定義可能
- 天候・時間帯の情報は外部から注入可能なコンテキストオブジェクトとして設計

---

## P-4: Semantic Zoom — 意味的ズームと認知負荷の最小化

> **情報は「必要なとき」に「必要な粒度」で提示せよ。**

### 宣言

ズームレベルとユーザーの目的に応じて、膨大な空間情報を
動的にフィルタリング・集約し、常に認知負荷を最小限に保つ。
全情報を常に表示するのは設計の失敗である。

### 判断基準

| 問い | 正しい答え |
|---|---|
| キャンパス全体表示で個別の部屋名を表示するか？ | **しない。建物名のみ表示し、ズームインで段階的に詳細化** |
| エディターとビューアーで同じズーム制御を使うか？ | **基本概念は共通だが、表示される情報レイヤーは役割に応じて異なる** |
| 経路グラフのノード・エッジは常に表示するか？ | **エディターでは切替可能。ビューアーではルート探索時のみ表示** |

### この原理から導かれる制約

- ズームレベルの段階ごとに表示すべき情報が定義されたテーブルを持つ
- レイヤー（建物外形／部屋詳細／経路グラフ／メタデータ）は独立してON/OFF可能
- テキストラベルの表示・非表示・集約はズームレベルに連動
- ビューアーのUIは「目的選択 → 結果表示」の2ステップを基本とする

---

## P-5: Data Normalization & Extensibility — データの正規化と拡張性

> **データは正規化して構造化し、必須フィールドを要求しない。**

### 宣言

すべてのデータは正規化されたリレーショナル構造で管理する。
フィールドに「必須」を設けず、欠損はシステムが自動補完する。
スキーマは将来の拡張を許容し、コア型の変更なしに新しい属性を追加できる。

### 判断基準

| 問い | 正しい答え |
|---|---|
| あるフィールドを「必須」にすべきか？ | **しない。デフォルト値または自動推論で補完する** |
| 新しい属性（例: "防音等級"）を追加したい場合、型定義を変更するか？ | **しない。拡張フィールド（`properties`）で対応する** |
| データの重複（非正規化）はパフォーマンスのために許すか？ | **原則不可。参照IDで結合する。キャッシュは別レイヤーで行う** |

### この原理から導かれる制約

- エンティティ間はIDの参照で結合する（データの埋め込みではなく正規化）
- 全フィールドにデフォルト値を定義する（`type` → `'other'`, `distance` → 自動計算, etc.）
- 拡張属性は `properties: Record<string, unknown>` で自由に追加可能
- スキーマバージョニングにより後方互換性を維持する

---

## P-6: Mathematical Abstraction — 数理モデルによる空間の抽象化

> **空間要素は、座標・ベクトル・行列の数学的対象として扱え。**

### 宣言

建物・部屋・通路などの物理空間を、点・線分・多角形・グラフなどの
数理モデルとして抽象化し、変換・回転・投影などの演算を
一貫した数学的インターフェースで行う。

### 判断基準

| 問い | 正しい答え |
|---|---|
| 空間要素の位置をどう管理するか？ | **座標ベクトル `(x, y, z)` と変換行列** |
| 3Dビューの実現方法は？ | **座標に対するアフィン変換・投影変換をDOM上で適用（React DOM）** |
| 衝突判定やポリゴン内包判定は？ | **幾何学アルゴリズム（点のポリゴン内包判定、線分交差判定等）を使用** |

### この原理から導かれる制約

- 位置は `{x, y}` のベクトル、3D表現は `{x, y, z}` で扱う
- 回転・スケール・移動は変換行列（アフィン変換）で統一的に処理
- 疑似3Dビューは座標変換＋CSS transform で DOM 上に実現
- 幾何学的演算（距離計算、交差判定、面積計算）は純粋関数として分離

---

## 原理の優先順位

原理が競合した場合、以下の順で優先する。

```
§0 (プロダクト定義) > P-1 (Topology) > P-2 (Constraint) > P-3 (Context) > P-4 (Zoom) > P-5 (Data) > P-6 (Math)
```

**理由:** プロダクト定義（何を作るか）が全ての前提。
トポロジーが正しくなければ制約チェックが機能せず、
制約が守られなければ正しいルーティングは不可能であり、
ルーティングが正しくなければ表示最適化に意味がない。
データの正規化と数理的抽象化は、上位原理をHOWレベルで支える基盤である。

---

## 反パターン（Anti-Patterns）

以下は本プロジェクトにおいて**明示的に禁止される設計判断**である。

| 反パターン | 違反する原理 | 正しいアプローチ |
|---|---|---|
| 画像の上にピンを置くだけの「地図」 | P-1 | ノードとエッジで空間をグラフ化せよ |
| ユーザーが自由に線を引ける「お絵かきモード」 | P-2 | スナップと制約で正しい入力のみ許可せよ |
| 距離のみで経路を計算する | P-3 | 多次元コスト関数を適用せよ |
| 全情報を一画面に表示するダッシュボード | P-4 | ズームと目的に応じた段階的開示を行え |
| フィールドの空欄でエラーを出す | P-5 | デフォルト値または自動補完で補え |
| 「必須」フィールドを新設する | P-5 | 全フィールドは省略可能にし、システムが補完せよ |
| Canvas/WebGLで描画する | §0 | React DOMで描画せよ |
| 座標を文字列やピクセル値でアドホックに管理する | P-6 | 数理モデル（ベクトル、変換行列）で統一的に処理せよ |
| グラフの整合性を無視した「見た目優先」の修正 | P-1 > P-4 | トポロジーの正しさは可視化の美しさに常に優先する |
| データを非正規化してコンポーネントに埋め込む | P-5 | IDで参照し、正規化を維持せよ |
