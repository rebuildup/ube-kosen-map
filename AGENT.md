# AGENT.md — 作業ルール＆品質基準

> **エージェントはこのファイルに従って作業を遂行せよ。**
> 判断の根拠は常に `CORE_POLICY.md` に求め、このファイルは「どう作るか」を定義する。

---

## 作業の原則

### 1. 調べてから作れ（Look Before You Leap）

コードを書く前に、以下を必ず確認する。

```
1. CORE_POLICY.md の該当原理を特定
2. docs/ 以下の関連仕様を読む
3. 既存コードベースを検索し、重複・矛盾がないか確認
4. 判断を下し、根拠を明記してから実装に着手
```

### 2. 小さく作って検証せよ（Small Steps, Constant Validation）

- 1つのPRで1つの関心事のみ扱う
- 各ステップで CORE_POLICY との整合性を確認する
- 「動くが原理に反するコード」より「未完成だが原理に沿ったコード」を優先

### 3. 型で意図を表現せよ（Types as Documentation）

- ドメインモデルは TypeScript の型として厳密に定義する
- `any` の使用は禁止。`unknown` + 型ガードで安全に処理する
- Union型とBranded型を活用し、不正な状態を型レベルで排除する

---

## 意思決定フレームワーク

判断に迷った場合、以下の手順で解決する。

### ステップ1: 原理マッピング

```
この判断は CORE_POLICY のどの原理に関わるか？
→ §0 (定義) / P-1 (Topology) / P-2 (Constraint) / P-3 (Context) / P-4 (Zoom) / P-5 (Data) / P-6 (Math)
```

### ステップ2: 選択肢の列挙と評価

```
選択肢A: [内容] → §0: ✅ / P-1: ✅ / P-2: ✅ / P-3: ⚠️ / P-4: ✅ / P-5: ✅ / P-6: ✅
選択肢B: [内容] → §0: ✅ / P-1: ❌ / P-2: ✅ / P-3: ✅ / P-4: ✅ / P-5: ✅ / P-6: ✅
→ P-1違反のため、選択肢Bは棄却。選択肢Aを採用。
```

### ステップ3: トレードオフの記録

選択肢に明確な勝者がない場合：
- 上位原理（§0 > P-1 > P-2 > P-3 > P-4 > P-5 > P-6）に沿う選択肢を優先
- トレードオフの内容をコミットメッセージまたはコードコメントに記録

---

## コーディング規約

### ファイル命名

| 種類 | 規約 | 例 |
|---|---|---|
| コンポーネント | PascalCase | `TraceEditor.tsx` |
| ユーティリティ | camelCase | `graphUtils.ts` |
| 型定義 | camelCase + `.types` | `graph.types.ts` |
| テスト | 同名 + `.test` | `graphUtils.test.ts` |
| ドキュメント | kebab-case | `system-overview.md` |

### コード構造

```typescript
// ===== ファイルの構造テンプレート =====

// 1. インポート（外部 → 内部 → 型の順）
import { externalLib } from 'external-lib';
import { internalModule } from '@/core/module';
import type { NodeId, EdgeId } from '@/core/graph.types';

// 2. 型定義（このファイル固有のもの）
interface LocalConfig { /* ... */ }

// 3. 定数
const DEFAULT_SNAP_THRESHOLD = 8; // px

// 4. メイン実装
export function mainFunction() { /* ... */ }

// 5. ヘルパー（非公開）
function helperFunction() { /* ... */ }
```

### CORE_POLICY 関連のコードコメント

原理に基づく重要な設計判断には、以下の形式でコメントを付ける。

```typescript
// [P-1] ドアの配置時にエッジを自動生成する。
//       形状の編集とグラフの更新は常に同期しなければならない。
function placeDoor(wallSegment: WallSegment, position: Point): Door {
  // ...
}

// [P-2] 孤立ノードの存在を許容しない。
//       ノード削除時に接続エッジが0になる場合は操作を拒否する。
function deleteNode(nodeId: NodeId): Result<void, ValidationError> {
  // ...
}
```

---

## コミット規約

### 形式

```
<type>(<scope>): <subject>

[body]

[POLICY: P-N] (該当する場合)
```

### type一覧

| type | 用途 |
|---|---|
| `feat` | 新機能の追加 |
| `fix` | バグ修正 |
| `refactor` | リファクタリング（機能変更なし） |
| `docs` | ドキュメントのみの変更 |
| `test` | テストの追加・修正 |
| `chore` | ビルド・設定等の変更 |

### scope 一覧

| scope | 対象 |
|---|---|
| `core` | グラフ構造・制約エンジン |
| `editor` | トレースエディター |
| `viewer` | キャンパスビューアー |
| `routing` | ルーティングエンジン |
| `schema` | データモデル・型定義 |
| `math` | 数理ライブラリ |
| `autocomplete` | 自動補完エンジン |
| `docs` | ドキュメント |

### 例

```
feat(core): ドア配置時のエッジ自動生成を実装

壁セグメント上にドアを配置した際、隣接する2つのスペース間に
自動的にエッジを生成する機能を追加。

POLICY: P-1 (Topology First), P-2 (Constraint-Driven)
```

---

## 品質基準

### 必須チェック（マージ前に必ず通すこと）

- [ ] **型チェック:** `tsc --noEmit` がエラーなしで通る
- [ ] **リント:** ESLint/Biome がエラーなしで通る
- [ ] **テスト:** 関連するテストが全てパスする
- [ ] **CORE_POLICY チェック:** 変更が§0およびP-1〜P-6のいずれかに違反していないか確認済み

### グラフ整合性テスト（P-1 関連）

以下のテストは `core/` への変更時に必ずパスすること：

- 全ノードが少なくとも1つのエッジに接続されている（孤立ノードなし）
- 全エッジが有効なノードIDを参照している（壊れた参照なし）
- 階段ノードの上下階対応が一致している
- グラフの連結成分が妥当である（意図しない分断がない）

### 制約テスト（P-2 関連）

- ドアが壁セグメント上にのみ配置されている
- スナップポイントが正しく計算されている
- バリデーションエラーが適切に検出・表示されている

### データ正規化テスト（P-5 関連）

- 全フィールドが省略可能で、省略時に自動補完が正しく動作する
- エンティティ間の結合がIDの参照のみで行われている（埋め込みなし）
- `properties` フィールドで拡張属性が正しく保存・読込される

### 数理演算テスト（P-6 関連）

- ベクトル演算（加減算、内積、外積、正規化）が正しく動作する
- 変換行列（回転・移動・拡大縮小）の合成が正しい
- ポリゴンの内包判定・交差判定が正確である

---

## ドキュメント更新ルール

コードの変更時、以下に該当する場合はドキュメントも同時に更新する。

| 変更内容 | 更新すべきドキュメント |
|---|---|
| 新しいノード/エッジ種別の追加 | `docs/data-model/graph-schema.md` |
| 新しいエディター機能の追加 | `docs/features/01-trace-editor.md` |
| 新しいルーティングプロファイルの追加 | `docs/features/03-dynamic-routing.md` |
| 新しいメタデータフィールドの追加 | `docs/features/02-metadata-management.md` |
| アーキテクチャの変更 | `docs/architecture/system-overview.md` |
| 用語の追加・変更 | `CLAUDE.md` のドメイン用語集 |

---

## エージェント向け最終チェックリスト

作業完了時、以下を自問せよ。

```
□ §0: React DOMで描画しているか？ Canvas/WebGLを使っていないか？
□ §0: データはJSONで管理しているか？
□ P-1: グラフとしてのトポロジーは正しいか？
□ P-2: 制約チェックは実装したか？
□ P-3: コスト関数の拡張性は維持されているか？
□ P-4: UIの情報開示はズーム連動になっているか？
□ P-5: 必須フィールドを新設していないか？ 自動補完は実装したか？
□ P-5: データは正規化されているか？ IDのみの参照で結合しているか？
□ P-6: 空間要素は数理モデルとして抽象化されているか？
□ 型安全性は保たれているか？ (any は使っていないか？)
□ テストは書いたか？
□ ドキュメントは更新したか？
□ コミットメッセージに POLICY タグを付けたか？
```
