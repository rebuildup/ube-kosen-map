# CLAUDE.md — エージェント・エントリポイント

> **AIエージェントはこのファイルを最初に読み、プロジェクトの全体像を把握せよ。**

---

## プロジェクト概要

**宇部高専キャンパスの空間情報デジタルツイン基盤。**

物理世界のキャンパス空間を数理モデルとして抽象化し、
グラフ構造で再現するReactベースのWebアプリケーション。

### 2つのアプリケーション層

| 層 | 対象ユーザー | 目的 |
|---|---|---|
| **トレースエディター** | 管理者・データ構築者 | 平面図から空間をグラフとしてトレース・編集 |
| **キャンパスビューアー** | 教職員・学生（実務利用） | 条件付きルート検索・施設情報の閲覧 |

---

## 思考の手順 — 何かを判断する前に

1. **`CORE_POLICY.md` §0 を確認する** — プロダクト定義と技術的制約（React DOM / JSON / 数理モデル）
2. **`CORE_POLICY.md` P-1〜P-6 を参照する** — 6つの設計原理が全判断の基準
3. **`AGENT.md` を参照する** — 作業ルール・品質基準・コミット規約
4. **`docs/` 以下の該当仕様を参照する** — 機能仕様・データモデルの詳細
5. **原理に基づいて判断を下し、根拠を明記する**

```
CORE_POLICY.md        ← 設計原理（なぜそうするか）
  ├── CLAUDE.md       ← 今読んでいるファイル（何を作るか）
  ├── AGENT.md        ← 作業ルール（どう作るか）
  └── docs/
      ├── architecture/system-overview.md   ← システム構成図
      ├── features/01-trace-editor.md       ← 機能仕様①
      ├── features/02-metadata-management.md← 機能仕様②
      ├── features/03-dynamic-routing.md    ← 機能仕様③
      ├── features/04-visualization.md      ← 機能仕様④
      ├── data-model/graph-schema.md        ← データモデル定義
      └── reference/binran.pdf              ← 学校便覧（参考資料）
```

---

## 技術スタック（確定）

| カテゴリ | 決定事項 | CORE_POLICY根拠 |
|---|---|---|
| **描画方式** | **React DOM** — すべての空間要素はDOMノードとして描画。Canvas/WebGL禁止 | §0 |
| **データ管理** | **JSON** — キャンパスデータはJSONファイルで保存・読込 | §0 |
| **配布形態** | **Reactコンポーネント** — マップは描画要素と操作関数を持つコンポーネントとして提供 | §0 |
| **空間表現** | **数理モデル** — 座標ベクトル・変換行列・グラフ理論で空間を抽象化 | P-6 |
| **3D表現** | **CSS Transform** — アフィン変換・射影変換をDOMに適用して疑似3Dを実現 | §0 + P-6 |
| **フレームワーク** | TypeScript + React | — |
| **グラフ構造** | 隣接リスト形式の型安全なデータ構造 | P-1 |
| **ルーティング** | A*/Dijkstra + プラガブルコスト関数 | P-3 |
| **データ設計** | 正規化・ID参照結合・必須フィールドなし・自動補完 | P-5 |

### 技術選定時の判断チェックリスト

新しいライブラリや技術を導入する前に以下を確認：

- [ ] §0: React DOM描画の原則を破っていないか？
- [ ] P-1: グラフ構造（ノード・エッジ）の操作を妨げないか？
- [ ] P-2: 制約チェックのレイヤーを挟む余地があるか？
- [ ] P-3: コスト関数の拡張性を損なわないか？
- [ ] P-4: 描画の段階的開示（ズーム連動）に対応できるか？
- [ ] P-5: データの正規化原則を破っていないか？
- [ ] P-6: 数理モデルの一貫性を損なわないか？

---

## プロジェクト構造（予定）

```
ube-kosen-map/
├── CORE_POLICY.md          # 設計原理
├── CLAUDE.md               # このファイル
├── AGENT.md                # 作業ルール
├── docs/                   # 仕様ドキュメント
│   ├── architecture/
│   ├── features/
│   ├── data-model/
│   └── reference/
├── src/                    # ソースコード（今後作成）
│   ├── core/               # グラフ構造・制約エンジン・ルーティング・数理演算
│   ├── editor/             # トレースエディターUI
│   ├── viewer/             # キャンパスビューアーUI
│   ├── components/         # マップReactコンポーネント（配布用）
│   ├── math/               # ベクトル・行列・幾何学演算ユーティリティ
│   └── shared/             # 共通ユーティリティ・型定義
├── data/                   # キャンパスデータ（JSON）
├── tests/                  # テスト
└── public/                 # 静的アセット（平面図画像等）
```

---

## ドメイン用語集

| 用語 | 定義 |
|---|---|
| **ノード (Node)** | グラフ上の点。部屋・廊下の交差点・階段の踊り場など、移動可能な場所を抽象化したもの |
| **エッジ (Edge)** | 2つのノード間の移動可能な接続。距離・段差・屋内外等の属性を持つ |
| **スペース (Space)** | 部屋や廊下などの物理的空間を表すポリゴン。1つ以上のノードを内包する |
| **ドア (Door)** | 2つのスペースを接続するポイント。エッジの生成トリガーとなる |
| **フロア (Floor)** | 建物内の1階層。Z軸インデックスで管理 |
| **プロファイル (Profile)** | ルーティング時のコスト計算条件セット（例: 台車モード、雨天モード） |
| **コスト関数 (Cost Function)** | エッジの通行コストを計算する関数。`(edge, profile, context) → number` |
| **セマンティックズーム** | ズームレベルに応じて表示情報の粒度を動的に変化させる仕組み |
| **トレース (Trace)** | 平面図上で空間の輪郭をポリゴンとして描画する操作 |
| **バリデーション (Validation)** | グラフ・制約の整合性を検証する処理 |
| **数理モデル** | 空間要素を座標・ベクトル・行列・グラフ等の数学的対象として表現したもの |
| **変換行列** | 回転・スケール・移動・投影を統一的に表現する行列 |
| **アフィン変換** | 平行移動・回転・拡大縮小・せん断を組み合わせた線形変換 |
| **正規化 (Normalization)** | データの重複を排除し、IDによる参照で関連を表現するデータ設計手法 |
| **自動補完 (Auto-completion)** | 未入力フィールドにシステムがデフォルト値や推論値を設定する仕組み |
