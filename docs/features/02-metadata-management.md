# 機能仕様: 空間・属性メタデータ管理

> **関連原理:** P-3 (Context-Aware Dynamics), P-1 (Topology First)
> **コンポーネント:** Core Engine (Metadata Store)

---

## 概要

トレースエディターで構築したグラフ構造に対して、
各ノード・エッジ・スペースに意味を持つ属性情報（メタデータ）を付加・管理する機能。
ルーティングのコスト計算（P-3）や空間検索の基盤となる。

---

## F2-1: 属性スキーマ定義

### ノード属性

| フィールド | 型 | 必須 | 説明 |
|---|---|---|---|
| `id` | `NodeId` (branded string) | ✅ | 一意識別子 |
| `type` | `NodeType` enum | ✅ | `room` / `corridor_junction` / `staircase` / `entrance` / `elevator` |
| `position` | `{ x, y }` | ✅ | 平面図上の座標 |
| `floorId` | `FloorId` | ✅ | 所属フロア |
| `label` | `string` | ❌ | 表示名（例: "3F 会議室A"） |

### エッジ属性

| フィールド | 型 | 必須 | 説明 | コスト影響 |
|---|---|---|---|---|
| `id` | `EdgeId` (branded string) | ✅ | 一意識別子 | — |
| `sourceNodeId` | `NodeId` | ✅ | 始点ノード | — |
| `targetNodeId` | `NodeId` | ✅ | 終点ノード | — |
| `distance` | `number` (meters) | ✅ | 物理的距離 | 基本コスト |
| `hasSteps` | `boolean` | ✅ | 段差の有無 | 台車モードで∞ |
| `isOutdoor` | `boolean` | ✅ | 屋外フラグ | 雨天モードでコスト増 |
| `width` | `number` (meters) | ✅ | 通路幅 | 狭路回避で影響 |
| `isVertical` | `boolean` | ✅ | 垂直移動（階段・EV） | 垂直コスト計算 |
| `direction` | `'bidirectional' \| 'forward' \| 'backward'` | ✅ | 通行方向 | 一方通行制御 |

### スペース属性

| フィールド | 型 | 必須 | 説明 |
|---|---|---|---|
| `id` | `SpaceId` (branded string) | ✅ | 一意識別子 |
| `type` | `SpaceType` enum | ✅ | `classroom` / `lab` / `office` / `corridor` / `stairwell` / `restroom` / `storage` / `other` |
| `name` | `string` | ✅ | 正式名称（例: "電気電子工学科 実験室1"） |
| `buildingId` | `BuildingId` | ✅ | 所属建物 |
| `floorId` | `FloorId` | ✅ | 所属フロア |
| `polygon` | `Point[]` | ✅ | 形状を定義する座標列 |
| `containedNodeIds` | `NodeId[]` | ✅ | 内包するノード群 |
| `tags` | `string[]` | ❌ | 自由タグ（例: `["プロジェクター", "エアコン"]`） |
| `manager` | `string` | ❌ | 管理者・管理部署 |
| `capacity` | `number` | ❌ | 収容人数 |
| `notes` | `string` | ❌ | 備考 |

---

## F2-2: 属性の入力・編集UI

### 属性パネル

グラフ要素（ノード・エッジ・スペース）を選択すると、
サイドパネルにその要素の属性が表示される。

```
┌─────────────────────────┐
│ 属性パネル               │
│─────────────────────────│
│ ■ スペース: 電子工学実験室 │
│                         │
│ 種別: [実験室 ▼]         │
│ 管理者: [電気電子工学科]   │
│ 収容人数: [40]           │
│ タグ: [プロジェクター][+] │
│ 備考: ___________        │
│                         │
│ ── 含まれるノード (2) ── │
│ ・N-0042 (room)          │
│ ・N-0043 (room)          │
│                         │
│ ── 接続エッジ (3) ──     │
│ ・E-0101: → 廊下 (5.2m)  │
│ ・E-0102: → 準備室 (3.0m)│
│ ・E-0103: → 廊下 (4.8m)  │
└─────────────────────────┘
```

### 制約 [P-2]

- `type` が未選択のスペースは保存時にバリデーション警告
- `hasSteps`, `isOutdoor`, `width` はエッジの必須フィールドであり、デフォルト値を設定
- 必須フィールドが空の場合、属性パネルに警告を表示

---

## F2-3: 空間クエリ機能

### 要件

エンドユーザーが属性を条件として空間を検索できる。

### クエリ例

| ユースケース | クエリ条件 |
|---|---|
| 「プロジェクターのある教室」 | `type = classroom AND tags CONTAINS "プロジェクター"` |
| 「3F以上の部屋」 | `floor.level >= 3` |
| 「電気電子工学科の部屋」 | `manager CONTAINS "電気電子"` |
| 「40人以上入れる部屋」 | `capacity >= 40` |

### 検索インターフェース

- **テキスト検索:** 名前・管理者・タグに対する部分一致検索
- **フィルター検索:** 種別・建物・階でのドロップダウン選択
- **複合条件:** 上記を AND で組み合わせ可能

### 検索結果の表示 [P-4]

- 検索結果に該当するスペースをマップ上でハイライト表示
- 結果リストをクリックすると該当スペースにズーム＆パン
- ズームレベルに応じて結果のラベル表示粒度を調整

### 受け入れ条件

- [ ] テキスト検索で名前・タグにマッチする部屋が一覧表示される
- [ ] フィルターで種別・建物・階を絞り込める
- [ ] 検索結果がマップ上にハイライトされる
- [ ] 結果クリックで該当スペースにフォーカスが移動する
