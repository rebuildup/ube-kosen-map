# 機能仕様: 可視化・インターフェース

> **関連原理:** P-4 (Semantic Zoom), P-6 (Mathematical Abstraction), §0 (React DOM)
> **コンポーネント:** UI層 (マップReactコンポーネント)

---

## 概要

構築されたグラフデータと計算された経路を、
ユーザーの目的・ズームレベルに応じて最適な粒度で表示する機能群。

**技術的制約:** すべての描画は **React DOM** で行う。
疑似3Dビューを含むすべての空間表現は、CSS Transform（アフィン変換・射影変換）をDOMノードに適用して実現する。

---

## F4-1: ビューモード

マップは 3つの基本ビューモード を持つ。

### F4-1-1: 上空ビュー（Campus Aerial View）

キャンパス全体を上空から見下ろす2D平面図。

| 特徴 | 内容 |
|---|---|
| 視点 | 真上 |
| 表示対象 | キャンパス全体の建物配置、屋外通路 |
| ズーム | セマンティックズーム連動（Z-1〜Z-5） |
| 用途 | 全体把握、ルート表示、施設検索 |

### F4-1-2: フロア上空ビュー（Floor Aerial View）

特定の建物の特定の階を上空から見下ろす2D平面図。

| 特徴 | 内容 |
|---|---|
| 視点 | 真上（1フロア分） |
| 表示対象 | 選択階のスペース配置、ノード、エッジ |
| 透過表示 | 上下1階ずつを薄く重ねて階段位置を参照可能 |
| 用途 | フロア内の詳細確認、エディターでの編集 |

### F4-1-3: 断面ビュー（Cross-Section View）

建物を横から見た断面図。4方向（北・東・南・西）から切り替え可能。

| 特徴 | 内容 |
|---|---|
| 視点 | 4方向の側面（北/東/南/西）切替 |
| 表示対象 | 各階の断面、階段・エレベーターの縦の繋がり |
| 用途 | フロア間の関係把握、垂直動線の確認 |

### F4-1-4: 疑似3Dビュー（Pseudo-3D View）

フロアをZ軸方向に分解し、斜めまたは横から俯瞰する立体的なビュー。
**React DOMとCSS Transformで実現する。**

| 特徴 | 内容 |
|---|---|
| 視点 | 自由な角度（ドラッグで回転） |
| 描画方法 | 各フロアのDOM要素に `transform: rotateX() rotateY() translateZ()` を適用 |
| 表示対象 | 各フロアの面構成、垂直接続線（階段・EV） |
| 操作 | 視点角度のドラッグ回転 + フロア間距離のスライダー調整 |
| 用途 | プレゼンテーション、建物全体の構造把握 |

```
CSS Transform による疑似3D実現:

各フロアDOM要素
  ├─ transform-style: preserve-3d
  ├─ transform: translateZ(level * spacing)
  └─ 親コンテナに perspective + rotateX + rotateY を適用

→ ブラウザのCSS 3D変換エンジンがDOMを立体的に配置
```

### F4-1-5: 建物別ビュー（Building View）

特定の建物にフォーカスしたビュー。上記すべてのビューモードをこの建物に限定して表示する。

---

## F4-2: ビュー操作

すべてのビューモードで共通の操作系を提供する。
**スマートフォンのタッチ操作に完全対応すること。**

### 基本操作

| 操作 | デスクトップ | スマホ/タブレット | 挙動 |
|---|---|---|---|
| **パン（移動）** | ドラッグ | 1指ドラッグ | マップを平行移動 |
| **ズーム** | ホイールスクロール | ピンチイン/アウト | スケール変更（ズーム中心はカーソル/ピンチ中心） |
| **Z軸回転** | Shift+ドラッグ | 2指回転 | マップを回転（軸はドラッグ開始点/2指の中心点） |

### ダブルタップ段階ズーム

ダブルタップ（ダブルクリック）で段階的にズームと全画面化を行う。

```
状態遷移:

[通常表示] ──ダブルタップ──→ [ズームレベル+1]
    ↑                            │
    │                        ダブルタップ
    │                            ↓
    │                      [ズームレベル+2]
    │                            │
    │                        ダブルタップ
    │                            ↓
    │                      [マップ全画面化]
    │                            │
    │                        ダブルタップ
    └────────────────────────────┘
         [全画面解除 → 元のズーム状態に復帰]
```

| 段階 | 状態 | 挙動 |
|---|---|---|
| 1回目 | 通常 → ズーム+1 | タップ位置を中心にズームイン |
| 2回目 | ズーム+1 → ズーム+2 | さらにズームイン |
| 3回目 | ズーム+2 → 全画面化 | マップがビューポート全体に展開 |
| 4回目 | 全画面 → 元の状態 | 全画面解除、ダブルタップ前のズーム・位置に復帰 |

### 全画面化

| 操作 | 挙動 |
|---|---|
| 全画面ボタン | マップコンポーネントがビューポート全体に展開 |
| ESCキー / 戻るジェスチャー | 全画面解除、元のサイズ・位置に復帰 |
| ダブルタップ（段階3） | 上記段階ズームの一部として全画面化 |

### Z軸回転の詳細

| プラットフォーム | 操作 | 回転軸 |
|---|---|---|
| デスクトップ | Shift + ドラッグ | ドラッグ開始時のカーソル位置 |
| スマホ | 2指を回転 | 2指の中心点 |

```
回転の実装:

回転軸(cx, cy) = ドラッグ開始点 or 2指中心
角度θ = atan2(dy, dx) の差分
→ マップコンテナに transform: rotate(θ) を適用
→ transform-origin: cx cy を設定
```

---

## F4-3: セマンティックズーム

### ズームレベル定義テーブル

| レベル | 名称 | 表示スケール | 表示内容 |
|---|---|---|---|
| Z-1 | キャンパス全景 | 全体が画面に収まる | 建物の外形 + 建物名ラベル |
| Z-2 | 建物グループ | 建物2〜3棟 | 建物外形 + 各棟の階数表示 |
| Z-3 | 建物詳細 | 建物1棟 | フロア輪郭 + 主要なスペース名 |
| Z-4 | フロア詳細 | フロア1階分 | 全スペースの輪郭 + 名称 + ノード位置 |
| Z-5 | スペース詳細 | 部屋数個 | スペース内部の詳細 + メタデータ + エッジ表示 |

### レイヤーのズーム連動

| レイヤー | Z-1 | Z-2 | Z-3 | Z-4 | Z-5 |
|---|---|---|---|---|---|
| 建物外形 | ● | ● | ● | ○ | ○ |
| 建物名ラベル | ● | ● | ○ | — | — |
| スペース輪郭 | — | — | ● | ● | ● |
| スペース名ラベル | — | — | 主要のみ | ● | ● |
| ノード（点） | — | — | — | ● | ● |
| エッジ（線） | — | — | — | 主要のみ | ● |
| メタデータ | — | — | — | — | ● |

`●` = 表示 / `○` = 薄く表示 / `—` = 非表示

---

## F4-4: ダイナミックレイヤー制御

### レイヤー一覧

| レイヤー | デフォルト | 説明 |
|---|---|---|
| **ベースマップ** | ON | 平面図画像 |
| **建物外形** | ON | 建物の外形ポリゴン |
| **スペース** | ON | 部屋・廊下のポリゴン（色分け） |
| **経路グラフ** | OFF (ビューアー) / ON (エディター) | ノードとエッジの表示 |
| **ルート** | ON (検索時のみ) | 計算された経路のハイライト |
| **メタデータ** | OFF | アイコン・タグ情報の表示 |
| **バリデーション** | ON (エディターのみ) | エラー/警告の表示 |

### 制約

- エディターモードでは「バリデーション」レイヤーは非表示不可（P-2）
- レイヤー状態はセッション間で永続化する
- レイヤーの不透明度をスライダーで調整可能

---

## F4-5: 経路表示と案内

### 経路ハイライト

| 表示要素 | スタイル |
|---|---|
| 出発地マーカー | 緑のピン |
| 目的地マーカー | 赤のピン |
| 経路線 | 太い青線（アニメーション付き） |
| フロア遷移ポイント | 矢印アイコン（↑↓ + "3F→2F"ラベル） |
| 代替経路 | 細い灰色の点線 |

### ターンバイターン案内

```
┌───────────────────────────────┐
│ 経路案内                       │
│ 総距離: 185m  推定時間: 約3分    │
│                               │
│ 1. 電気電子工学科棟 3F 実験室   │
│    → 右に出て廊下へ            │
│ 2. 3F 廊下を北へ 30m           │
│ 3. 中央階段で 2F へ降りる       │
│ 4. 渡り廊下を通って管理棟へ     │
│ 5. 管理棟 2F 事務室 [到着]      │
│                               │
│ ⚠ 雨天時: 渡り廊下は屋外です    │
└───────────────────────────────┘
```

---

## F4-6: マップReactコンポーネント設計

マップは再利用可能なReactコンポーネントとして提供する。

### コンポーネントインターフェース（概念）

```typescript
interface CampusMapProps {
  /** キャンパスグラフデータ (JSON) */
  data: CampusGraph;

  /** 初期ビューモード */
  initialView?: ViewMode;

  /** 初期ズームレベル */
  initialZoom?: number;

  /** ルーティングプロファイル */
  routingProfile?: RoutingProfile;

  /** イベントハンドラ */
  onNodeSelect?: (nodeId: NodeId) => void;
  onSpaceSelect?: (spaceId: SpaceId) => void;
  onRouteCalculated?: (route: Route) => void;
}

type ViewMode =
  | 'aerial'          // 上空ビュー
  | 'floor'           // フロア上空ビュー
  | 'cross-section'   // 断面ビュー（4方向）
  | 'pseudo-3d'       // 疑似3Dビュー
  | 'building';       // 建物別ビュー
```

### 公開する操作関数

```typescript
interface CampusMapRef {
  /** ビュー操作 */
  setView(mode: ViewMode): void;
  setZoom(level: number): void;
  panTo(point: Point): void;
  rotate(angle: number, pivot?: Point): void;
  toggleFullscreen(): void;

  /** フロア操作 */
  setFloor(buildingId: BuildingId, level: number): void;
  setCrossSectionDirection(dir: 'north' | 'east' | 'south' | 'west'): void;

  /** 検索・ルーティング */
  findRoute(from: NodeId, to: NodeId, profile?: RoutingProfile): Route;
  highlightSpaces(spaceIds: SpaceId[]): void;
  clearHighlights(): void;

  /** データアクセス */
  getNode(id: NodeId): GraphNode | undefined;
  getSpace(id: SpaceId): Space | undefined;
}
```

### 受け入れ条件

- [ ] 3つのビューモード（aerial / floor / cross-section）が切替可能
- [ ] 疑似3Dビューが CSS Transform で DOM 上に実現される
- [ ] ピンチズーム・パン・Z軸回転がスマホタッチで操作可能
- [ ] ダブルタップで段階ズーム → 全画面化 → 元の状態復帰
- [ ] Shift+ドラッグ / 2指回転でZ軸回転（軸はドラッグ開始点/2指中心）
- [ ] 建物別ビューが機能する
- [ ] セマンティックズーム（Z-1〜Z-5）でレイヤーが切り替わる
- [ ] 全操作がReactコンポーネントのrefから関数で呼び出せる
