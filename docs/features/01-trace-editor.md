# 機能仕様: トレース＆モデリングエディター

> **関連原理:** P-1 (Topology First), P-2 (Constraint-Driven Editing)
> **コンポーネント:** Trace Editor → Core Engine (Graph Manager + Constraint Engine)

---

## 概要

管理者が平面図画像をベースレイヤーとして、キャンパス内の建物・部屋・廊下・階段等を
ポリゴンとしてトレースし、それらをグラフ構造（ノード＋エッジ）として構築するための
専用Webエディター。

**核心:** 「絵を描く」のではなく「グラフを構築する」行為であることをUIが表現すること。

> 2026-02-27 更新: 本機能はメンテナンスモード。
> 実データの主作成経路は `docs/features/05-svg-data-pipeline.md` のSVGパイプラインを優先する。

---

## F1-1: CADライクスナップ描画

### 要件

ポリゴンの頂点を配置する際、以下のスナップが自動的に適用される。

| スナップ種別 | 挙動 | 閾値（デフォルト） |
|---|---|---|
| **頂点スナップ** | 既存の頂点に吸着 | 8px |
| **辺スナップ** | 既存の辺（線分）上の最近点に吸着 | 6px |
| **直交スナップ** | 直前の辺に対して90°方向にガイドを表示 | 常時 |
| **平行スナップ** | 近傍の辺と平行なガイドを表示 | 常時 |
| **グリッドスナップ** | グリッド交点に吸着（任意ON/OFF） | グリッド間隔に依存 |

### スナップの優先順位

複数のスナップが競合する場合：

```
頂点スナップ > 辺スナップ > 直交/平行スナップ > グリッドスナップ
```

**理由:** 既存のトポロジーとの接続を最優先する（P-1）。

### 制約 [P-2]

- スナップは基本的に無効化できない（精密モードで閾値の調整のみ可能）
- スナップした結果をユーザーに視覚的にフィードバックする（色変化 + ツールチップ）
- スナップ計算は空間インデックス（四分木等）を用いて高速化する

### 受け入れ条件

- [ ] 頂点スナップ: 閾値内の最近接頂点にカーソルが吸着する
- [ ] 辺スナップ: 閾値内の辺上に最近点が表示される
- [ ] 直交・平行ガイド: 描画中にリアルタイムでガイド線が表示される
- [ ] スナップ発生時に視覚的フィードバック（色、アイコン）が表示される
- [ ] 閾値は設定パネルから調整可能

---

## F1-2: トポロジカル・オートリンク

### 要件

空間要素（スペース）間に「ドア」を配置した瞬間、経路グラフが自動的に更新される。

### 処理フロー

```
1. ユーザーが壁セグメント上にドアを配置
   └─ Constraint Engine: ドアの位置が壁セグメント上か検証 [P-2]
       ├─ NG → 操作を拒否、理由を表示
       └─ OK → 2へ

2. ドアが接する2つのスペースを自動検出
   └─ 壁セグメントが共有する隣接スペースをジオメトリから導出

3. 各スペースのアンカーノードを特定または生成
   └─ スペース内のノードがなければ中心点にノードを生成 [P-1]

4. 2つのアンカーノード間にエッジを自動生成
   └─ エッジ属性: 距離（自動計算）, 段差=none（デフォルト）, 屋内=true

5. グラフの更新を反映し、ビジュアルを再描画
```

### 制約 [P-2]

- ドアは必ず壁セグメント上にのみ配置可能
- ドアの削除時は、対応するエッジも自動削除（確認ダイアログ付き）
- 1つの壁セグメントに複数のドアを配置可能（それぞれ独立したエッジ）

### 受け入れ条件

- [ ] ドアを壁に配置すると、隣接する2スペース間にエッジが自動生成される
- [ ] ドアを壁以外に配置しようとすると操作が拒否される
- [ ] ドア削除時に関連エッジの削除確認が表示される
- [ ] 自動生成されたエッジが経路グラフに正しく統合される

---

## F1-3: マルチフロア（Z軸）透過編集

### 要件

キャンパスは複数の建物、各建物が複数の階で構成される。
エディターは現在編集中の階を中心に、上下階の構造を透過的に表示し、
垂直方向のノード接続を矛盾なく行えるようにする。

### フロアモデル

```typescript
interface Floor {
  buildingId: BuildingId;      // 所属建物
  level: number;               // 階数（1F=1, B1=-1, RF=屋上）
  baseImageUrl: string;        // 平面図画像のURL
  offset: { x: number, y: number }; // 平面図の位置合わせオフセット
  opacity: number;             // 表示時の不透明度
}
```

### 表示モード

| 表示対象 | 不透明度 | 操作可否 |
|---|---|---|
| 現在の階 | 100% | 完全に編集可能 |
| 1つ上/下の階 | 30% | 表示のみ（階段位置の参照用） |
| 2つ以上離れた階 | 非表示 | — |

### 垂直接続ルール [P-1 + P-2]

```
1. 階段ノードを現在の階に配置
2. 対応する上/下階にも階段ノードが存在するか検証
   ├─ 存在する → 垂直エッジを自動生成
   └─ 存在しない → 警告を表示（「対応する階段ノードがありません」）
3. 既存の垂直エッジとの整合性を検証
```

### 受け入れ条件

- [ ] 上下階の構造が半透明で表示される
- [ ] 階段ノードの配置時に上下階との整合性が検証される
- [ ] 垂直エッジが正しく生成される
- [ ] フロア切替がスムーズに行える（ショートカットキー対応）

---

## F1-4: リアルタイム・バリデーション

### 要件

編集中のグラフに対して、以下のバリデーションをリアルタイムで実行し、
エラー・警告をキャンバス上に表示する。

### バリデーションルール

| ID | ルール | 重大度 | 関連原理 |
|---|---|---|---|
| V-001 | 孤立ノード（エッジが0本） | Error | P-1 |
| V-002 | 片端が欠損したエッジ | Error | P-1 |
| V-003 | 出入り口（ドア）のないスペース | Warning | P-1 |
| V-004 | 対応する上下階ノードがない階段 | Warning | P-1 + P-2 |
| V-005 | 自己ループエッジ（同一ノードへの接続） | Error | P-1 |
| V-006 | 重複エッジ（同じ2ノード間に複数の同一エッジ） | Warning | P-1 |
| V-007 | スペース外に存在するノード | Warning | P-2 |
| V-008 | 壁を貫通するエッジ（ドアを経由しない接続） | Error | P-2 |

### 表示方法

- **Error:** 対象ノード/エッジを赤くハイライト + エラーアイコン表示
- **Warning:** 対象を黄色くハイライト + 警告アイコン表示
- **バリデーションパネル:** 全エラー/警告のリストを常時表示、クリックで対象にフォーカス

### 実行タイミング

- 編集操作のたびに差分バリデーション（変更された部分のみ再検証）
- 保存時に全体バリデーション（全ルール完全実行）

### 受け入れ条件

- [ ] 上記8種のバリデーションルールが全て機能する
- [ ] バリデーションエラーがキャンバス上にリアルタイムで表示される
- [ ] バリデーションパネルからエラー箇所にジャンプできる
- [ ] 差分バリデーションが50ms以内に完了する（ノード数1000以下の場合）
